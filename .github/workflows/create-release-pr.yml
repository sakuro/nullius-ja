name: Create release PR
on:
  workflow_dispatch:
    inputs:
      version:
          description: "New version to be released (without prefix 'v')"
          required: true
jobs:
  Create-Release-PR:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set current date
        id: current_date
        run: |
          echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Create release PR
        env:
          PR_BRANCH: release-v${{ github.event.inputs.version }}
          GIT_USER_NAME: github-actions[bot]
          GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"
          git switch -c "${PR_BRANCH}"
          (rm -f info.json && jq -M '.version|="${{ github.event.inputs.version }}"' > info.json) < info.json
          (rm -f changelog.txt && sed -e '1i\
          ---------------------------------------------------------------------------------------------------\
          Version: ${{ github.event.inputs.version }}\
          Date: ${{ steps.current_date.outputs.date }}\
            Changes:\
              - \
            Bugfix:\
              - ' | sed -e 's/          //' > changelog.txt) < changelog.txt
          git add info.json changelog.txt
          git commit -m 'Bump to v${{ github.event.inputs.version }}'
          git push origin "${PR_BRANCH}"
          cat <<-EOF | jq -R | jq -s | jq 'map(split(":") | {(.[0]): .[1]}) | add' | \
          curl \
            --request POST \
            --header 'Accept: application/vnd.github.v3+json' \
            --header 'Authorization: token ${{ secrets.GITHUB_TOKEN }}' \
            --url https://api.github.com/repos/${{ github.repository }}/pulls \
            --data @-
          title:Release v${{ github.event.inputs.version }}
          body:This PR is automatically created by the GitHub Action workflow ${{ github.workflow }}
          head:${PR_BRANCH}
          base:main
          EOF
